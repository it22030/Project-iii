<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Update Order Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>

<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">üçî Admin - Update Orders</h2>

    <div id="orderList"></div>
    <button id="addOrder" class="btn btn-secondary mt-3">Add New Order</button>
</div>

<script>
    const socket = new SockJS('http://localhost:8085/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function() {
        console.log("‚úÖ Connected to WebSocket");
    });

    const orderList = document.getElementById('orderList');
    const addOrderBtn = document.getElementById('addOrder');

    // Track order update states
    const orderStates = {};

    function createOrderRow() {
        const row = document.createElement('div');
        row.className = 'd-flex gap-2 mb-2 align-items-center';
        row.innerHTML = `
        <input type="text" placeholder="Order ID" class="form-control order-id" style="width: 20%;">
        <input type="text" placeholder="User ID" class="form-control user-id" style="width: 20%;">
        <button class="btn btn-primary" data-status="Prepared">Prepared</button>
        <button class="btn btn-warning text-white" data-status="Ready">Ready</button>
        <button class="btn btn-success" data-status="Delivered">Delivered</button>
        <span class="text-muted small ms-2" id="statusTime"></span>
    `;

        const buttons = row.querySelectorAll('button');
        const timeLabel = row.querySelector('#statusTime');

        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = row.querySelector('.order-id').value.trim();
                const userId = row.querySelector('.user-id').value.trim();
                const status = this.getAttribute('data-status');

                if (!orderId || !userId) {
                    alert("‚ö†Ô∏è Please enter both Order ID and User ID!");
                    return;
                }

                // Confirm before sending
                if (!confirm(`Are you sure you want to mark Order ${orderId} as "${status}"?`)) {
                    return;
                }

                // Check if already completed
                if (orderStates[orderId] === "Delivered") {
                    alert("‚úÖ This order is already completed!");
                    return;
                }

                // Validate proper order flow
                const prevStatus = orderStates[orderId];
                if (status === "Ready" && prevStatus !== "Prepared") {
                    alert("‚ö†Ô∏è You must mark as 'Prepared' first!");
                    return;
                }
                if (status === "Delivered" && prevStatus !== "Ready") {
                    alert("‚ö†Ô∏è You must mark as 'Ready' first!");
                    return;
                }

                // Generate timestamp
                const now = new Date();
                const timeString = now.toLocaleString();

                // Send update payload
                const payload = { orderId, userId, status, time: timeString };
                stompClient.send("/app/order/status", {}, JSON.stringify(payload));

                // Update UI state
                orderStates[orderId] = status;
                timeLabel.textContent = `Last update: ${timeString}`;

                // Disable clicked button
                this.disabled = true;
                this.classList.add("opacity-50");

                // If delivered, disable all buttons for this order
                if (status === "Delivered") {
                    buttons.forEach(b => b.disabled = true);
                }

                alert(`üì§ Order ${orderId} status sent to ${userId} as "${status}"`);
                console.log(`‚úÖ Sent ${status} update for Order ${orderId} to User ${userId}`);
            });
        });

        orderList.appendChild(row);
    }

    // Add initial order row
    createOrderRow();
    addOrderBtn.addEventListener('click', createOrderRow);
</script>
</body>
</html>
